local WindUI
do
    local ok, result = pcall(function()
        return require("./src/Init")
    end)
    if ok then
        WindUI = result
    else
        WindUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/refs/heads/main/dist/main.lua"))()
    end
end

-- Core Variables
local BuyLucky = false
local AutoSell = false
local Hop = false

local PriorityItems = {
    "Lucky Arrow",
    "Lucky Stone Mask",
    "Green Candy",
    "Red Candy",
    "Blue Candy",
    "Yellow Candy"
}

local SellItems = {
    ["Gold Coin"] = true,
    ["Rokakaka"] = true,
    ["Pure Rokakaka"] = true,
    ["Mysterious Arrow"] = true,
    ["Diamond"] = true,
    ["Ancient Scroll"] = true,
    ["Caesar's Headband"] = true,
    ["Stone Mask"] = true,
    ["Rib Cage of The Saint's Corpse"] = true,
    ["Quinton's Glove"] = true,
    ["Zeppeli's Hat"] = true,
    ["Lucky Arrow"] = false,
    ["Lucky Stone Mask"] = false,
    ["Clackers"] = true,
    ["Steel Ball"] = true,
    ["Dio's Diary"] = true,
    ["Green Candy"] = false,
    ["Red Candy"] = false,
    ["Blue Candy"] = false,
    ["Yellow Candy"] = false
}

-- Services
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local MarketplaceService = game:GetService("MarketplaceService")
local TeleportService = game:GetService("TeleportService")

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

-- Anti-Cheat Bypasses
game:GetService("CoreGui").DescendantAdded:Connect(function(child)
    if child.Name == "ErrorPrompt" then
        local GrabError = child:FindFirstChild("ErrorMessage", true)
        repeat task.wait() until GrabError.Text ~= "Label"
        local Reason = GrabError.Text
        if Reason:match("kick") or Reason:match("You") or Reason:match("conn") or Reason:match("rejoin") then
            TeleportService:Teleport(2809202155, Player)
        end
    end
end)

local Has2x = MarketplaceService:UserOwnsGamePassAsync(Player.UserId, 14597778)

local oldMagnitude
oldMagnitude = hookmetamethod(game.Vector3.new(), "__index", newcclosure(function(self, index)
    local CallingScript = tostring(getcallingscript())
    if not checkcaller() and rawequal(index, "magnitude") and CallingScript == "ItemSpawn" then
        return 0
    end
    return oldMagnitude(self, index)
end))

local UzuKeeIsRetardedAndDoesntKnowHowToMakeAnAntiCheatOnTheServerSideAlsoVexStfuIKnowTheCodeIsBadYouDontNeedToTellMe = "  ___XP DE KEY"

local oldNc
oldNc = hookmetamethod(game, "__namecall", newcclosure(function(self, ...)
    local Method = getnamecallmethod()
    local Args = {...}
    if not checkcaller() and rawequal(self.Name, "Returner") and rawequal(Args[1], "idklolbrah2de") then
        return UzuKeeIsRetardedAndDoesntKnowHowToMakeAnAntiCheatOnTheServerSideAlsoVexStfuIKnowTheCodeIsBadYouDontNeedToTellMe
    end
    return oldNc(self, ...)
end))

-- Helper Functions
local function GetCharacter(Part)
    if Player.Character then
        if not Part then
            return Player.Character
        elseif typeof(Part) == "string" then
            return Player.Character:FindFirstChild(Part) or nil
        end
    end
    return nil
end

local function TeleportTo(Position)
    local HumanoidRootPart = GetCharacter("HumanoidRootPart")
    if HumanoidRootPart then
        local PositionType = typeof(Position)
        if PositionType == "CFrame" then
            HumanoidRootPart.CFrame = Position
        end
    end
end

local function ToggleNoclip(Value)
    local Character = GetCharacter()
    if Character then
        for _, Child in pairs(Character:GetDescendants()) do
            if Child:IsA("BasePart") and Child.CanCollide == not Value then
                Child.CanCollide = Value
            end
        end
    end
end

local MaxItemAmounts = {
    ["Gold Coin"] = 45,
    ["Rokakaka"] = 25,
    ["Pure Rokakaka"] = 10,
    ["Mysterious Arrow"] = 25,
    ["Diamond"] = 30,
    ["Ancient Scroll"] = 10,
    ["Caesar's Headband"] = 10,
    ["Stone Mask"] = 10,
    ["Rib Cage of The Saint's Corpse"] = 20,
    ["Quinton's Glove"] = 10,
    ["Zeppeli's Hat"] = 10,
    ["Lucky Arrow"] = 15,
    ["Lucky Stone Mask"] = 10,
    ["Clackers"] = 10,
    ["Steel Ball"] = 10,
    ["Dio's Diary"] = 10,
    ["Green Candy"] = 45,
    ["Red Candy"] = 45,
    ["Blue Candy"] = 45,
    ["Yellow Candy"] = 45
}

if Has2x then
    for Index, Max in pairs(MaxItemAmounts) do
        MaxItemAmounts[Index] = Max * 2
    end
end

local function HasMaxItem(Item)
    local Count = 0
    for _, Tool in pairs(Player.Backpack:GetChildren()) do
        if Tool.Name == Item then
            Count += 1
        end
    end
    if MaxItemAmounts[Item] then
        return Count >= MaxItemAmounts[Item]
    else
        return false
    end
end

local function HasLuckyArrows()
    local Count = 0
    for _, Tool in pairs(Player.Backpack:GetChildren()) do
        if Tool.Name == "Lucky Arrow" then
            Count += 1
        end
    end
    return Count >= 9
end

local function IsPriorityItem(ItemName)
    for _, PriorityName in pairs(PriorityItems) do
        if ItemName == PriorityName then
            return true
        end
    end
    return false
end

local ItemSpawnFolder = Workspace:WaitForChild("Item_Spawns"):WaitForChild("Items")
getgenv().SpawnedItems = {}

ItemSpawnFolder.ChildAdded:Connect(function(Model)
    task.wait(1)
    if Model:IsA("Model") then
        local ItemInfo = GetItemInfo(Model)
        if ItemInfo then
            table.insert(getgenv().SpawnedItems, ItemInfo)
        end
    end
end)

local function GetItemInfo(Model)
    if Model and Model:IsA("Model") and Model.Parent and Model.Parent.Name == "Items" then
        local PrimaryPart = Model.PrimaryPart
        if not PrimaryPart then return nil end
        local Position = PrimaryPart.Position
        local ProximityPrompt
        for _, ItemInstance in pairs(Model:GetChildren()) do
            if ItemInstance:IsA("ProximityPrompt") and ItemInstance.MaxActivationDistance == 8 then
                ProximityPrompt = ItemInstance
            end
        end
        if ProximityPrompt then
            return {
                ["Name"] = ProximityPrompt.ObjectText,
                ["ProximityPrompt"] = ProximityPrompt,
                ["Position"] = Position,
                ["IsPriority"] = IsPriorityItem(ProximityPrompt.ObjectText)
            }
        end
    end
    return nil
end

-- Main Farming State
local farmingActive = false
local farmingThread = nil

local function SortItems()
    table.sort(getgenv().SpawnedItems, function(a, b)
        if a.IsPriority and not b.IsPriority then
            return true
        elseif not a.IsPriority and b.IsPriority then
            return false
        else
            return false
        end
    end)
end

local function farmLoop()
    while farmingActive do
        if #getgenv().SpawnedItems > 0 then
            SortItems()
            
            for Index = #getgenv().SpawnedItems, 1, -1 do
                local ItemInfo = getgenv().SpawnedItems[Index]
                local HumanoidRootPart = GetCharacter("HumanoidRootPart")
                
                if HumanoidRootPart and ItemInfo then
                    local Name = ItemInfo.Name
                    local HasMax = HasMaxItem(Name)
                    
                    if not HasMax then
                        local ProximityPrompt = ItemInfo.ProximityPrompt
                        local Position = ItemInfo.Position
                        
                        if ProximityPrompt and ProximityPrompt.Parent then
                            table.remove(getgenv().SpawnedItems, Index)
                            
                            local BodyVelocity = Instance.new("BodyVelocity")
                            BodyVelocity.Parent = HumanoidRootPart
                            BodyVelocity.Velocity = Vector3.new(0, 0, 0)
                            BodyVelocity.MaxForce = Vector3.new(100000, 100000, 100000)
                            
                            ToggleNoclip(true)
                            TeleportTo(CFrame.new(Position.X, Position.Y + 25, Position.Z))
                            task.wait(.5)
                            
                            pcall(function()
                                fireproximityprompt(ProximityPrompt)
                            end)
                            
                            task.wait(.5)
                            BodyVelocity:Destroy()
                            ToggleNoclip(false)
                            TeleportTo(CFrame.new(978, -42, -49))
                        else
                            table.remove(getgenv().SpawnedItems, Index)
                        end
                    else
                        table.remove(getgenv().SpawnedItems, Index)
                    end
                end
            end
        end
        
        if #getgenv().SpawnedItems == 0 then
            if AutoSell then
                for Item, Sell in pairs(SellItems) do
                    if Sell and Player.Backpack and Player.Backpack:FindFirstChild(Item) then
                        local Character = GetCharacter()
                        if Character and Character:FindFirstChild("Humanoid") and Character:FindFirstChild("RemoteEvent") then
                            Character.Humanoid:EquipTool(Player.Backpack:FindFirstChild(Item))
                            task.wait(.1)
                            Character.RemoteEvent:FireServer("EndDialogue", {
                                ["NPC"] = "Merchant",
                                ["Dialogue"] = "Dialogue5",
                                ["Option"] = "Option2"
                            })
                            task.wait(.2)
                        end
                    end
                end
            end
            
            local Money = Player.PlayerStats.Money
            
            if BuyLucky and not HasLuckyArrows() then
                while Money.Value >= 75000 do
                    local Character = GetCharacter()
                    if Character and Character:FindFirstChild("RemoteEvent") then
                        Character.RemoteEvent:FireServer("PurchaseShopItem", {["ItemName"] = "1x Lucky Arrow"})
                        task.wait(.1)
                    else
                        break
                    end
                end
            end
            
            if Hop and #getgenv().SpawnedItems == 0 then
                local ShouldHop = true
                if BuyLucky and not HasLuckyArrows() and Money.Value >= 50000 then
                    ShouldHop = false
                end
                
                if ShouldHop then
                    pcall(function()
                        loadstring(game:HttpGet("https://raw.githubusercontent.com/rinqedd/pub_rblx/main/ServerHop", true))()
                    end)
                    task.wait(3)
                else
                    task.wait(5)
                end
            else
                task.wait(5)
            end
        else
            task.wait(1)
        end
    end
end

local function startFarming()
    if farmingThread then return end
    
    -- Setup HUD if needed
    if not PlayerGui:FindFirstChild("HUD") then
        local HUD = ReplicatedStorage.Objects.HUD:Clone()
        HUD.Parent = PlayerGui
    end
    
    -- Remove loading screens
    task.spawn(function()
        pcall(function() PlayerGui:WaitForChild("LoadingScreen1"):Destroy() end)
        task.wait(.5)
        pcall(function() PlayerGui:WaitForChild("LoadingScreen"):Destroy() end)
        pcall(function() workspace.LoadingScreen.Song:Destroy() end)
    end)
    
    -- Wait for character and start
    repeat task.wait() until GetCharacter() and GetCharacter("RemoteEvent")
    GetCharacter("RemoteEvent"):FireServer("PressedPlay")
    TeleportTo(CFrame.new(978, -42, -49))
    task.wait(5)
    
    farmingActive = true
    farmingThread = task.spawn(farmLoop)
    
    WindUI:Notify({
        Title = "Zakori",
        Content = "Auto farming started!",
        Icon = "check"
    })
end

local function stopFarming()
    farmingActive = false
    if farmingThread then
        task.cancel(farmingThread)
        farmingThread = nil
    end
    
    WindUI:Notify({
        Title = "Zakori",
        Content = "Auto farming stopped!",
        Icon = "x"
    })
end

-- Create UI
local Window = WindUI:CreateWindow({
    Title = "Zakori YBA",
    Icon = "skull",
    Author = "by Zakori",
    Folder = "zakori_yba",
    NewElements = true,
    HideSearchBar = false,
    OpenButton = {
        Title = "Open Zakori UI",
        CornerRadius = UDim.new(1,0),
        StrokeThickness = 3,
        Enabled = true,
        Draggable = true,
        OnlyMobile = false,
        Color = ColorSequence.new(
            Color3.fromHex("#30FF6A"),
            Color3.fromHex("#e7ff2f")
        )
    }
})

Window:SetToggleKey(Enum.KeyCode.K)

local ZakoriTab = Window:Tab({
    Title = "Zakori",
    Icon = "skull"
})

-- Auto Farm Toggle
ZakoriTab:Toggle({
    Flag = "AutoFarm",
    Title = "Auto Farm",
    Default = false,
    Callback = function(value)
        if value then
            startFarming()
        else
            stopFarming()
        end
    end
})

-- Auto Buy Lucky Arrow Toggle
ZakoriTab:Toggle({
    Flag = "AutoBuyLucky",
    Title = "Auto Buy Lucky Arrow",
    Default = false,
    Callback = function(value)
        BuyLucky = value
        WindUI:Notify({
            Title = "Zakori",
            Content = "Auto buy lucky arrow " .. (value and "enabled" or "disabled"),
            Icon = value and "check" or "x"
        })
    end
})

-- Auto Sell Toggle
ZakoriTab:Toggle({
    Flag = "AutoSell",
    Title = "Auto Sell",
    Default = false,
    Callback = function(value)
        AutoSell = value
        WindUI:Notify({
            Title = "Zakori",
            Content = "Auto sell " .. (value and "enabled" or "disabled"),
            Icon = value and "check" or "x"
        })
    end
})

-- Initial notification
WindUI:Notify({
    Title = "Zakori",
    Content = "Script loaded successfully!",
    Icon = "check"
})
